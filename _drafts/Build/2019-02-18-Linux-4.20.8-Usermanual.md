---
layout: post
title:  "Linux_MMKK Usermanual[Linux_JJKK]"
date:   2019-02-21 09:30:30 +0800
categories: [Build]
excerpt: Linux_MMKK Usermanual.
tags:
  - Linux
---

> [GitHub: BiscuitOS](https://github.com/BiscuitOS/BiscuitOS)
>
> Email: BuddyZhang1 <Buddy.zhang@aliyun.com>

# ç›®å½•

> - [å¼€å‘ç¯å¢ƒæ­å»º](#å¼€å‘ç¯å¢ƒæ­å»º)
>
> - [BiscuitOS ç¼–è¯‘è¿è¡Œ](#BiscuitOS ç¼–è¯‘è¿è¡Œ)
>
> - [é…ç½® Linux_MMKK å†…æ ¸](#é…ç½® Linux_MMKK å†…æ ¸)
>
> - [ç¼–è¯‘ Linux_MMKK å†…æ ¸](#ç¼–è¯‘ Linux_MMKK å†…æ ¸)
>
> - [è¿è¡Œ Linux_MMKK å†…æ ¸](#è¿è¡Œ Linux_MMKK å†…æ ¸)
>
> - [é©±åŠ¨å¼€å‘](#é©±åŠ¨å¼€å‘)
>
> - [è°ƒè¯• Linux_MMKK å†…æ ¸](#Linux_MMKK å†…æ ¸è°ƒè¯•)
>
> - [é™„å½•](#é™„å½•)

-----------------------------------------------

# <span id="å¼€å‘ç¯å¢ƒæ­å»º">å¼€å‘ç¯å¢ƒæ­å»º</span>

> - [å‡†å¤‡å¼€å‘ä¸»æœº](#å‡†å¤‡å¼€å‘ä¸»æœº)
>
> - [å®‰è£…åŸºç¡€å¼€å‘å·¥å…·](#å®‰è£…åŸºç¡€å¼€å‘å·¥å…·)
>
> - [è·å–æºç ](#è·å–æºç )

#### <span id="å‡†å¤‡å¼€å‘ä¸»æœº">å‡†å¤‡å¼€å‘ä¸»æœº</span>

å¼€å‘è€…é¦–å…ˆå‡†å¤‡ä¸€å° Linux å‘è¡Œç‰ˆç”µè„‘ï¼Œæ¨è Ubuntu 16.04/Ubuntu 18.04, Ubuntu ç”µ
è„‘çš„å®‰è£…å¯ä»¥ä¸Šç½‘æŸ¥æ‰¾ç›¸åº”çš„æ•™ç¨‹ã€‚å‡†å¤‡å¥½ç›¸åº”çš„å¼€å‘ä¸»æœºä¹‹åï¼Œè¯·å‚ç…§å¦‚ä¸‹æ–‡ç« è¿›è¡Œå¼€
å‘ä¸»æœºç»†èŠ‚é…ç½®ã€‚

> [BiscuitOS å¼€å‘ç¯å¢ƒæ­å»º](https://biscuitos.github.io/blog/PlatformBuild/)

#### <span id="å®‰è£…åŸºç¡€å¼€å‘å·¥å…·">å®‰è£…åŸºç¡€å¼€å‘å·¥å…·</span>

åœ¨ç¼–è¯‘ç³»ç»Ÿä¹‹å‰ï¼Œéœ€è¦å¯¹å¼€å‘ä¸»æœºå®‰è£…å¿…è¦çš„å¼€å‘å·¥å…·ã€‚ä»¥ Ubuntu ä¸ºä¾‹å®‰è£…åŸºç¡€çš„å¼€å‘
å·¥å…·ã€‚å¼€å‘è€…å¯ä»¥æŒ‰å¦‚ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š

{% highlight bash %}
sudo apt-get install -y qemu gcc make gdb git figlet
sudo apt-get install -y libncurses5-dev iasl
sudo apt-get install -y device-tree-compiler
sudo apt-get install -y flex bison libssl-dev libglib2.0-dev
sudo apt-get install -y libfdt-dev libpixman-1-dev
sudo apt-get install -y u-boot-tools libtool
{% endhighlight %}

å¦‚æœå¼€å‘ä¸»æœºæ˜¯ 64 ä½ç³»ç»Ÿï¼Œè¯·ç»§ç»­å®‰è£…å¦‚ä¸‹å¼€å‘å·¥å…·ï¼š

{% highlight bash %}
sudo apt-get install lib32z1 lib32z1-dev
{% endhighlight %}

ç¬¬ä¸€æ¬¡å®‰è£… git å·¥å…·éœ€è¦å¯¹ git è¿›è¡Œé…ç½®ï¼Œé…ç½®åŒ…æ‹¬ç”¨æˆ·åå’Œ Emailï¼Œè¯·å‚ç…§å¦‚ä¸‹å‘½ä»¤
è¿›è¡Œé…ç½®

{% highlight bash %}
git config --global user.name "Your Name"
git config --global user.email "Your Email"
{% endhighlight %}


#### <span id="è·å–æºç ">è·å–æºç </span>

åŸºç¡€ç¯å¢ƒæ­å»ºå®Œæ¯•ä¹‹åï¼Œå¼€å‘è€…ä» GitHub ä¸Šè·å–é¡¹ç›®æºç ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
git clone https://github.com/BiscuitOS/BiscuitOS.git
cd BiscuitOS
{% endhighlight %}

BiscuitOS é¡¹ç›®æ˜¯ä¸€ä¸ªç”¨äºåˆ¶ä½œç²¾ç®€ Linux å‘è¡Œç‰ˆï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨è¿™ä¸ªé¡¹ç›®è·å¾—å„ç§
ç‰ˆæœ¬çš„ Linux å†…æ ¸ï¼ŒåŒ…æ‹¬æœ€å¤è€çš„ Linux 0.11, Linux 0.97, Linux 1.0.1 ç­‰ç­‰ï¼Œä¹Ÿå¯
ä»¥è·å¾—æœ€æ–°çš„ Linux 4.20, Linux 5.0 ç­‰ç­‰ã€‚åªéœ€è¦æ‰§è¡Œç®€å•çš„å‘½ä»¤ï¼Œå°±èƒ½æ„å»ºä¸€ä¸ªå¯
è¿è¡Œå¯è°ƒå¼çš„ Linux å¼€å‘ç¯å¢ƒã€‚

------------------------------------------------------

# <span id="BiscuitOS ç¼–è¯‘è¿è¡Œ">BiscuitOS ç¼–è¯‘å¹¶è¿è¡Œ</span>

> - [BiscuitOS ç¼–è¯‘](#BiscuitOS ç¼–è¯‘)
>
> - [é…ç½® Linux_MMKK å†…æ ¸](#é…ç½® Linux_MMKK å†…æ ¸)
>
> - [ç¼–è¯‘ Linux_MMKK å†…æ ¸](#ç¼–è¯‘ Linux_MMKK å†…æ ¸)
>
> - [ç¼–è¯‘ BusyBox](#ç¼–è¯‘ BusyBox)
>
> - [Rootfs åˆ¶ä½œ](#Rootfs åˆ¶ä½œ)
>
> - [è¿è¡Œ Linux_MMKK å†…æ ¸](#è¿è¡Œ Linux_MMKK å†…æ ¸)

#### <span id="BiscuitOS ç¼–è¯‘">BiscuitOS ç¼–è¯‘</span>

è·å¾— BiscuitOS é¡¹ç›®ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ BiscuitOS æ„å»º Linux_MMKK çš„å¼€å‘ç¯å¢ƒã€‚å¼€å‘è€…
åªéœ€æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å°±å¯ä»¥è·å¾— Linux_MMKK å®Œæ•´çš„ BiscuitOSï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
cd BiscuitOS
make Linux_JJKK_defconfig
make
{% endhighlight %}

æ‰§è¡Œ make å‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼ŒBiscuitOS ä¼šä»ç½‘ä¸Šè·å¾—ç³»ç»Ÿè¿è¡Œæ‰€éœ€çš„å·¥å…·ï¼ŒåŒ…æ‹¬
binutils, GNU-GCC, linaro-GCC,Busybox å’Œ Qemu ç­‰å·¥å…·ï¼Œä»¥æ­¤æ„å»ºä¸€ä¸ªå®Œæ•´çš„ 
Rootfsã€‚ç¼–è¯‘è¿‡ç¨‹ä¸­éœ€è¦è¾“å…¥ root å¯†ç ï¼Œè¯·è‡ªè¡Œè¾“å…¥ï¼Œä½†è¯·ä¸è¦ä»¥ root ç”¨æˆ·æ‰§è¡Œ 
make å‘½ä»¤ã€‚ç¼–è¯‘å®Œæˆä¹‹åï¼Œåœ¨å‘½ä»¤è¡Œç»ˆç«¯ä¼šè¾“å‡ºå¤šæ¡ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬ Linux æºç çš„ä½
ç½®ï¼ŒBiscuitOS çš„ä½ç½®ï¼Œä»¥åŠ README ä½ç½®ã€‚å¦‚ä¸‹ï¼š

{% highlight perl %}
 ____  _                _ _    ___  ____  
| __ )(_)___  ___ _   _(_) |_ / _ \/ ___| 
|  _ \| / __|/ __| | | | | __| | | \___ \ 
| |_) | \__ \ (__| |_| | | |_| |_| |___) |
|____/|_|___/\___|\__,_|_|\__|\___/|____/ 
                                          
***********************************************
Output:
 BiscuitOS/output/Linux_JJKK 

linux:
 BiscuitOS/output/Linux_JJKK/linux/linux 

README:
 BiscuitOS/output/Linux_JJKK/README.md 

***********************************************
{% endhighlight %}

å¼€å‘è€…é¦–å…ˆæŸ¥çœ‹ README ä¸­çš„å†…å®¹ï¼ŒREADME ä¸­ä»‹ç»äº† Linux ç­‰ç¼–è¯‘æ–¹æ³•ï¼ŒæŒ‰ç…§ README 
ä¸­çš„æç¤ºå‘½ä»¤è¿›è¡Œç¼–è¯‘ã€‚ä¾‹å¦‚ README å†…å®¹å¦‚ä¸‹ï¼š

{% highlight bash %}
# Build Linux Kernel

```
cd BiscuitOS/output/Linux_JJKK/linux/linux
make ARCH=arm clean
make ARCH=arm vexpress_defconfig

make ARCH=arm menuconfig
  General setup --->
    ---> [*]Initial RAM filesystem and RAM disk (initramfs/initrd) support

  Device Driver --->
    [*] Block devices --->
        <*> RAM block device support
        (153600) Default RAM disk size

make ARCH=arm CROSS_COMPILE=BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- -j8
make ARCH=arm CROSS_COMPILE=BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- dtbs
```

# Build Busybox

```
cd BiscuitOS/output/Linux_JJKK/busybox/busybox
make clean
make menuconfig
  Busybox Settings --->
    Build Options --->
      [*] Build BusyBox as a static binary (no shared libs)

make CROSS_COMPILE=BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- -j8

make CROSS_COMPILE=BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- install
```


# Re-Build Rootfs

```
cd BiscuitOS/output/Linux_JJKK
./RunQemuKernel.sh pack
```


# Running Linux on Qemu

```
cd BiscuitOS/output/Linux_JJKK
./RunQemuKernel.sh start
```

# Debugging Linux Kernel

### First Terminal

```
cd BiscuitOS/output/Linux_JJKK
./RunQemuKernel.sh debug
```

### Second Terminal

```
BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi-gdb BiscuitOS/output/Linux_JJKK/linux/linux/vmlinux

(gdb) target remote :1234
(gdb) b start_kernel
(gdb) c
(gdb) info reg
```
{% endhighlight %}

#### <span id="é…ç½® Linux_MMKK å†…æ ¸">é…ç½® Linux_MMKK å†…æ ¸</span>

æ ¹æ® README ä¸­çš„æç¤ºï¼Œåœ¨è¿è¡Œå†…æ ¸ä¹‹å‰é…ç½® Linux å†…æ ¸ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/Linux_JJKK/linux/linux
make ARCH=arm clean
make ARCH=arm vexpress_defconfig
make ARCH=arm menuconfig
{% endhighlight %}

ä¸ºäº†ä½¿ Linux èƒ½åœ¨ QEMU ä¸Šè¿è¡Œï¼Œéœ€è¦è®©å†…æ ¸æ”¯æŒ Initramfs å’Œ RAM disk åŠŸèƒ½ï¼Œå¼€å‘
è€…å¯ä»¥å‚ç…§ä¸‹å›¾è¿›è¡Œé…ç½®ï¼š

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000243.png)

é€‰æ‹© **General setup**

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000244.png)

é€‰ä¸­ **Initial RAM filesystem and RAM disk (initramfs/initrd) support**

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000245.png)

é€‰æ‹© **Device Driver**

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000246.png)

é€‰æ‹© **Block devices**

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000247.png)

é€‰ä¸­ **RAM block device support**, å¹¶è®¾ç½® **Default RAM disk size** çš„å¤§å°ä¸º 
153600 . ä¿å­˜å¹¶é€€å‡ºï¼Œè‡³æ­¤ï¼ŒLinux é…ç½®å®Œæˆã€‚

#### <span id="ç¼–è¯‘ Linux_MMKK å†…æ ¸">ç¼–è¯‘ Linux_MMKK å†…æ ¸</span>

é…ç½®å®Œå†…æ ¸ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç¼–è¯‘å†…æ ¸ï¼Œæ ¹æ® README é‡Œæä¾›çš„å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼Œå…·ä½“å‘½
ä»¤å¦‚ä¸‹ï¼š

{% highlight bash %}
make ARCH=arm CROSS_COMPILE=BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- -j8
make ARCH=arm CROSS_COMPILE=BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- dtbs
{% endhighlight %}

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000248.png)

#### <span id="ç¼–è¯‘ BusyBox">ç¼–è¯‘ BusyBox</span>

ä¸ºäº†ä½¿ Linux åœ¨ QEMU ä¸Šè¿è¡Œï¼Œå¼€å‘è€…éœ€è¦ä¸º Linux å‡†å¤‡è¿è¡Œå¿…å¤‡çš„å·¥å…·ï¼Œæ‰€æœ‰çš„å¿…å¤‡
å·¥å…·åœ¨ BiscuitOS é¡¹ç›®æ‰§è¡Œ make ä¹‹åéƒ½å·²ç»å‡†å¤‡å¥½ï¼Œç°åœ¨å¼€å‘è€…å¯ä»¥é€‰æ‹©ä¼˜åŒ–æˆ–ä¸ä¼˜
åŒ–è¿™äº›å·¥å…·ï¼Œä¼˜åŒ–çš„ç»“æœå°±æ˜¯æ˜¯ ROOTFS çš„ä½“ç§¯å°½å¯èƒ½çš„å°ã€‚å¦‚æœå¼€å‘è€…ä¸æƒ³ä¼˜åŒ–ï¼Œå¯ä»¥
è·³è¿‡è¿™ä¸€èŠ‚ã€‚ä½¿ç”¨é»˜è®¤é…ç½®æºç ç¼–è¯‘çš„ BusyBox ä½“ç§¯è¾ƒå¤§ï¼Œå¼€å‘è€…å¯ä»¥å‚ç…§å¦‚ä¸‹å‘½ä»¤ç¼©
å‡ BusyBox

{% highlight bash %}
cd BiscuitOS/output/Linux_JJKK/busybox/busybox
make clean
make menuconfig
{% endhighlight %}

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000003.png)

é€‰æ‹© **Busybox Settings --->**

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000004.png)

é€‰æ‹© **Build Options --->**

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000005.png)

é€‰ä¸­ **Build BusyBox as a static binary (no shared libs)**ï¼Œä¿å­˜å¹¶é€€å‡ºã€‚ä½¿ç”¨
å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘ BusyBox

{% highlight bash %}
make CROSS_COMPILE=BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- -j8

make CROSS_COMPILE=BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- install
{% endhighlight %}

#### <span id="Rootfs åˆ¶ä½œ">Rootfs åˆ¶ä½œ</span>

ç¼–è¯‘å®Œä¸Šé¢çš„å·¥å…·å’Œ Linux ä¹‹åï¼Œè¿è¡Œå‰çš„æœ€åä¸€æ­¥å°±æ˜¯åˆ¶ä½œä¸€ä¸ªå¯è¿è¡Œçš„ Rootfsã€‚å¼€
å‘è€…å¯ä»¥ä½¿ç”¨ README ä¸­æä¾›çš„å‘½ä»¤è¿›è¡Œåˆ¶ä½œï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
cd BiscuitOS/output/Linux_JJKK
./RunQemuKernel.sh pack
{% endhighlight %}

#### <span id="è¿è¡Œ Linux_MMKK å†…æ ¸">è¿è¡Œ Linux_MMKK å†…æ ¸</span>

å®Œæˆä¸Šé¢çš„æ­¥éª¤ä¹‹åï¼Œå¼€å‘è€…å°±å¯ä»¥è¿è¡Œ Linux_MMKK å†…æ ¸ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ï¼š

{% highlight bash %}
cd BiscuitOS/output/Linux_JJKK
./RunQemuKernel.sh start
{% endhighlight %}

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000249.png)

è‡³æ­¤ï¼Œä¸€ä¸ª Linux_MMKK å†…æ ¸å·²ç»è¿è¡Œï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªå·±å…´è¶£å’Œéœ€æ±‚å¯¹å†…æ ¸è¿›è¡Œé­”æ”¹ã€‚

----------------------------------------------

# <span id="é©±åŠ¨å¼€å‘">é©±åŠ¨å¼€å‘</span>

> - [é©±åŠ¨æºç ](#é©±åŠ¨æºç )
>
> - [é©±åŠ¨åŠ å…¥åˆ°å†…æ ¸æºç æ ‘](#é©±åŠ¨åŠ å…¥åˆ°å†…æ ¸æºç æ ‘)
>
> - [é©±åŠ¨é…ç½®](#é©±åŠ¨é…ç½®)
>
> - [é©±åŠ¨ç¼–è¯‘](#ç¼–è¯‘é©±åŠ¨)
>
> - [é©±åŠ¨è¿è¡Œ](#é©±åŠ¨è¿è¡Œ)

Linux device driver æ˜¯å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºç¼–å†™å„ç±»å‹çš„å¤–å›´è®¾å¤‡é©±åŠ¨ã€‚BiscuitOS æ”¯
æŒ Linux_MMKK å†…æ ¸é©±åŠ¨çš„å¼€å‘ã€‚å¼€å‘è€…å¯ä»¥å‚ç…§ä¸‹é¢æ–¹æ³•è¿›è¡Œæ›´å¤šé©±åŠ¨å¼€å‘ã€‚

#### <span id="é©±åŠ¨æºç ">é©±åŠ¨æºç </span>

å¼€å‘è€…é¦–å…ˆå‡†å¤‡ä¸€ä»½é©±åŠ¨æºç ï¼Œå¯ä»¥æ“ä½œå¦‚ä¸‹æºç ï¼Œæœ¬èŠ‚ä¸­ä½¿ç”¨ä¸€ä»½ misc é©±åŠ¨ï¼Œå¹¶å‘½å
ä¸º BiscuitOS_drv.cï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š

{% highlight c %}
/*
 * Copyright (C) 2019.02.18 BUDXdyZhang1 <BUDXdy.zhang@aliyun.com>
 *
 * Misc device driver demo
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; version 2 of the License.
 */
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/init.h>
#include <linux/fs.h>
#include <linux/miscdevice.h>

#define DEV_NAME "BiscuitOS"

/* Open entence on driver */
static int misc_demo_open(struct inode *inode, struct file *filp)
{
    return 0;
}

/* Release entence on driver */
static int misc_demo_release(struct inode *inode, struct file *filp)
{
    return 0;
}

/* Read entence on driver */
static ssize_t misc_demo_read(struct file *filp, char __user *buffer,
                         size_t count, loff_t *offset)
{
    return 0;
}

/* Write entence on driver */
static ssize_t misc_demo_write(struct file *filp, const char __user *buf,
                               size_t count, loff_t *offset)
{
    return 0;
}

/* file_operations structure */
static struct file_operations misc_demo_fops = {
    .owner     = THIS_MODULE,
    .open      = misc_demo_open,
    .release   = misc_demo_release,
    .write     = misc_demo_write,
    .read      = misc_demo_read,
};

/* Misc device entence */
static struct miscdevice misc_demo_misc = {
    .minor    = MISC_DYNAMIC_MINOR,
    .name     = DEV_NAME,
    .fops     = &misc_demo_fops,
};

/* driver inited entence */
static __init int misc_demo_init(void)
{
    misc_register(&misc_demo_misc);
    return 0;
}

/* driver exit entence */
static __exit void misc_demo_exit(void)
{
    misc_deregister(&misc_demo_misc);
}
module_init(misc_demo_init);
module_exit(misc_demo_exit);

/* Module information */
MODULE_LICENSE("GPL v2");
{% endhighlight %}

#### <span id="é©±åŠ¨åŠ å…¥åˆ°å†…æ ¸æºç æ ‘">é©±åŠ¨åŠ å…¥åˆ°å†…æ ¸æºç æ ‘</span>

å¼€å‘è€…å‡†å¤‡å¥½æºç ä¹‹åï¼Œæ¥ç€å°†æºç æ·»åŠ åˆ°å†…æ ¸æºç æ ‘ã€‚å¼€å‘è€…åœ¨å†…æ ¸æºç æ ‘ç›®å½•ä¸‹ï¼Œæ‰¾
åˆ° drivers ç›®å½•ï¼Œç„¶ååœ¨ drivers ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º BiscuitOS çš„ç›®å½•ï¼Œç„¶åå°†æºç 
BiscuitOS_drv.c æ”¾å…¥åˆ° BiscuitOS ç›®å½•ä¸‹ã€‚æ¥ç€æ·»åŠ  Kconfig å’Œ Makefile æ–‡ä»¶ï¼Œå…·
ä½“å†…å®¹å¦‚ä¸‹ï¼š

##### **Kconfig**

{% highlight bash %}
menuconfig BISCUITOS_DRV
    bool "BiscuitOS Driver"

if BISCUITOS_DRV

config BISCUITOS_MISC
    bool "BiscuitOS misc driver"

endif # BISCUITOS_DRV
{% endhighlight %}

##### **Makefile**

{% highlight bash %}
obj-$(CONFIG_BISCUITOS_MISC)  += BiscuitOS_drv.o
{% endhighlight %}

æ¥ç€ä¿®æ”¹å†…æ ¸æºç æ ‘ drivers ç›®å½•ä¸‹çš„ Kconfigï¼Œåœ¨æ–‡ä»¶çš„é€‚å½“ä½ç½®åŠ ä¸Šå¦‚ä¸‹ä»£ç ï¼š

{% highlight bash %}
source "drivers/BiscuitOS/Kconfig"
{% endhighlight %}

ç„¶åä¿®æ”¹å†…æ ¸æºç æ ‘ drivers ç›®å½•ä¸‹çš„ Makefileï¼Œåœ¨æ–‡ä»¶çš„æœ«å°¾ä¸ŠåŠ ä¸Šå¦‚ä¸‹ä»£ç ï¼š

{% highlight bash %}
obj-$(CONFIG_BISCUITOS_DRV)  += BiscuitOS/
{% endhighlight %}

#### <span id="é©±åŠ¨é…ç½®">é©±åŠ¨é…ç½®</span>

å‡†å¤‡å¥½æ‰€éœ€çš„æ–‡ä»¶ä¹‹åï¼Œæ¥ä¸‹æ¥è¿›è¡Œé©±åŠ¨åœ¨å†…æ ¸æºç æ ‘ä¸­çš„é…ç½®ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/Linux_JJKK/linux/linux
make ARCH=arm menuconfig
{% endhighlight %}

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000250.png)

é¦–å…ˆåœ¨ç›®å½•ä¸­æ‰¾åˆ° **Device Driver --->** å›è½¦å¹¶è¿›å…¥å…¶ä¸­ã€‚

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000251.png)

æ¥ç€åœ¨ç›®å½•ä¸­æ‰¾åˆ° **BiscuitOS Driver --->** æŒ‰ Y é€‰ä¸­å¹¶æŒ‰å›è½¦é”®è¿›å…¥ã€‚

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000252.png)

æœ€åæŒ‰ Y é”®é€‰ä¸­ **BiscuitOS mis driver**ï¼Œä¿å­˜å¹¶é€€å‡ºå†…æ ¸é…ç½®

#### <span id="ç¼–è¯‘é©±åŠ¨">ç¼–è¯‘é©±åŠ¨</span>

é…ç½®å®Œé©±åŠ¨ä¹‹åï¼Œæ¥ä¸‹æ¥å°†ç¼–è¯‘é©±åŠ¨ã€‚å¼€å‘è€…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘é©±åŠ¨ï¼š

{% highlight bash %}
make ARCH=arm CROSS_COMPILE=BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- -j8
{% endhighlight %}

ä»ç¼–è¯‘çš„ log å¯ä»¥çœ‹å‡º BiscuitOS_drv.c å·²ç»è¢«ç¼–è¯‘è¿›å†…æ ¸ã€‚

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000100.jpg)

#### <span id="é©±åŠ¨è¿è¡Œ">é©±åŠ¨è¿è¡Œ</span>

é©±åŠ¨å·²ç»ç¼–è¯‘è¿›å…¥å†…æ ¸é•œåƒä¸­ï¼Œå¼€å‘è€…åªè¦è¿è¡Œæœ€æ–°çš„å†…æ ¸é•œåƒï¼Œé©±åŠ¨ä¹Ÿä¸€èµ·ä¼šè¢«æ‰§è¡Œã€‚
å¼€å‘è€…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿è¡Œé©±åŠ¨ï¼š

{% highlight bash %}
cd BiscuitOS/output/Linux_JJKK
./RunQemuKernel.sh start
{% endhighlight %}

é€šè¿‡ BiscuitOS_drv.c æºç ï¼Œå¯ä»¥çŸ¥é“ï¼Œç³»ç»Ÿåœ¨è¿è¡Œåï¼Œä¼šåœ¨ dev ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º
BiscuitOS èŠ‚ç‚¹. 

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000253.png)

è‡³æ­¤ï¼Œä¸€ä¸ªé©±åŠ¨å®Œæ•´çš„æ·»åŠ åˆ°å†…æ ¸ä¸­ã€‚å¼€å‘è€…å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé©±åŠ¨çš„ç§»æ¤å’Œè°ƒè¯•ã€‚
æ›´å¤š Linux å†…æ ¸é©±åŠ¨ï¼Œè¯·å‚çœ‹ 

> [BiscuitOS Device Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/#Enginerring)

-----------------------------------------------------

# <span id="Linux_MMKK å†…æ ¸è°ƒè¯•">Linux_MMKK å†…æ ¸è°ƒè¯•</span>

BiscuitOS çš„ Linux å†…æ ¸ä¹Ÿæ”¯æŒå¤šç§è°ƒè¯•ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ–¹å¼å°±æ˜¯ GDB è°ƒè¯•ï¼Œå¼€å‘è€…
å¯ä»¥ä½¿ç”¨ GDB å¯¹å†…æ ¸è¿›è¡Œå•æ­¥è°ƒè¯•ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š(å…·ä½“å‚ç…§ BiscuitOS ä¸­çš„ README)

é¦–å…ˆä½¿ç”¨ QEMU çš„è°ƒè¯•å·¥å…·ï¼Œå°†å†…æ ¸æŒ‚èµ·ç­‰å¾…è°ƒè¯•ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/Linux_JJKK
./RunQemuKernel.sh debug
{% endhighlight %}

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000254.png)

æ¥ç€åœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯ä¸­è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œä½œä¸º gdb server

{% highlight bash %}
BiscuitOS/output/Linux_JJKK/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi-gdb BiscuitOS/output/Linux_JJKK/linux/linux/vmlinux
{% endhighlight %}

è¾“å…¥ä»¥ä¸Šå‘½ä»¤ä¹‹åï¼Œåœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸­ï¼Œä¼šè¿›å…¥ gdb æ¨¡å¼ï¼Œæ­¤æ—¶ä»¥æ­¤è¾“å…¥ä¸€ä¸‹å‘½åè¿›è¡Œ 
gdb æŒ‚è½½ï¼š

{% highlight bash %}
(gdb) target remote :1234
{% endhighlight %}

ç„¶åå¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œå†…æ ¸è°ƒè¯•ï¼Œæ¯”å¦‚åœ¨ start_kernel å‡ºæ·»åŠ ä¸€ä¸ªæ–­ç‚¹è°ƒè¯•ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
(gdb) b start_kernel
(gdb) c
(gdb) list
(gdb) info reg
{% endhighlight %}

![LINUXP](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/BUDX000255.png)

-----------------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](https://biscuitos.github.io/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/HAB000036.jpg)
